(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const c={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"54192aef-a51b-4a5a-b397-a310d1cef54f","Content-Type":"application/json"}},u=e=>e.ok?e.json():Promise.reject({status:e.status,message:e.status===403?"Недостаточно прав для выполнения операции":`Ошибка: ${e.status}`}),ee=()=>fetch(`${c.baseUrl}/users/me`,{headers:c.headers}).then(u),W=()=>fetch(`${c.baseUrl}/cards`,{headers:c.headers}).then(u),te=({name:e,about:t})=>fetch(`${c.baseUrl}/users/me`,{method:"PATCH",headers:c.headers,body:JSON.stringify({name:e,about:t})}).then(u),oe=({avatar:e})=>fetch(`${c.baseUrl}/users/me/avatar`,{method:"PATCH",headers:c.headers,body:JSON.stringify({avatar:e})}).then(u),re=({name:e,link:t})=>fetch(`${c.baseUrl}/cards`,{method:"POST",headers:c.headers,body:JSON.stringify({name:e,link:t})}).then(u),ne=e=>fetch(`${c.baseUrl}/cards/${e}`,{method:"DELETE",headers:c.headers}).then(u),se=(e,t)=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:c.headers}).then(u),H=(e,t,o,r,n)=>{se(e,r).then(s=>{s.likes.some(_=>_._id===n)?t.classList.add("card__like-button_is-active"):t.classList.remove("card__like-button_is-active"),o&&(o.textContent=s.likes.length)}).catch(s=>{console.error("Ошибка изменения лайка:",s)})},ce=(e,t)=>ne(e).then(o=>{console.log(o.message),t.remove()}).catch(o=>{throw console.error("Ошибка удаления карточки:",o),o.status===403?alert("Недостаточно прав для удаления этой карточки"):alert("Не удалось удалить карточку. Попробуйте еще раз."),o}),le=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),j=(e,t,{onPreviewPicture:o,onLikeIcon:r,onDeleteCard:n,onInfoClick:s})=>{const l=le(),_=l.querySelector(".card__like-button"),L=l.querySelector(".card__like-count"),U=l.querySelector(".card__control-button_type_delete"),Z=l.querySelector(".card__control-button_type_info"),q=l.querySelector(".card__image");if(q.src=e.link,q.alt=e.name,l.querySelector(".card__title").textContent=e.name,e.owner&&e.owner._id&&e.owner._id===t?n&&U.addEventListener("click",()=>n(e._id,l)):U.remove(),s&&Z.addEventListener("click",()=>s(e._id)),e.likes&&Array.isArray(e.likes)?(L.textContent=e.likes.length,e.likes.some(g=>g._id===t)&&_.classList.add("card__like-button_is-active")):L.textContent=0,r){const D=e.likes&&e.likes.some(g=>g._id===t);_.addEventListener("click",()=>r(e._id,_,L,D,t))}return o&&q.addEventListener("click",()=>o({name:e.name,link:e.link})),l},J=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");i(t)}},m=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",J)},i=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",J)},ie=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{i(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&i(e)})},ae=(e,t,o,r)=>{const n=e.querySelector(`#${t.id}-error`);t.classList.add(r.inputErrorClass),n&&(n.textContent=o,n.classList.add(r.errorClass))},R=(e,t,o)=>{const r=e.querySelector(`#${t.id}-error`);t.classList.remove(o.inputErrorClass),r&&(r.textContent="",r.classList.remove(o.errorClass))},ue=(e,t,o)=>{if(t.validity.valid)R(e,t,o);else{let r=t.validationMessage;t.hasAttribute("data-error-message")&&t.validity.patternMismatch&&(r=t.getAttribute("data-error-message")),ae(e,t,r,o)}},de=e=>Array.from(e).some(t=>!t.validity.valid),pe=(e,t)=>{e.classList.add(t.inactiveButtonClass),e.disabled=!0},me=(e,t)=>{e.classList.remove(t.inactiveButtonClass),e.disabled=!1},k=(e,t,o)=>{t&&(de(e)?pe(t,o):me(t,o))},_e=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);k(o,r,t),o.forEach(n=>{n.addEventListener("input",function(){ue(e,n,t),k(o,r,t)})})},fe=e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{_e(o,e)})},E=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);o.forEach(n=>{R(e,n,t)}),r&&k(o,r,t)},V=document.querySelector(".places__list"),x=document.querySelector(".popup_type_edit"),d=x.querySelector(".popup__form"),z=d.querySelector(".popup__input_type_name"),K=d.querySelector(".popup__input_type_description"),I=document.querySelector(".popup_type_new-card"),a=I.querySelector(".popup__form"),ye=a.querySelector(".popup__input_type_card-name"),he=a.querySelector(".popup__input_type_url"),B=document.querySelector(".popup_type_image"),F=B.querySelector(".popup__image"),Se=B.querySelector(".popup__caption"),ve=document.querySelector(".profile__edit-button"),be=document.querySelector(".profile__add-button"),w=document.querySelector(".profile__title"),A=document.querySelector(".profile__description"),T=document.querySelector(".profile__image"),M=document.querySelector(".popup_type_edit-avatar"),p=M.querySelector(".popup__form"),$=p.querySelector(".popup__input"),P=document.querySelector(".popup_type_remove-card"),G=P.querySelector(".popup__form"),y=document.querySelector(".popup_type_info");y.querySelector(".popup__title");const f=y.querySelector(".popup__info"),N=y.querySelector(".popup__text"),O=y.querySelector(".popup__list");let S=null,v=null;const C={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},Ce=e=>e.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),h=(e,t)=>{const r=document.getElementById("popup-info-definition-template").content.querySelector(".popup__info-item").cloneNode(!0);return r.querySelector(".popup__info-term").textContent=e,r.querySelector(".popup__info-description").textContent=t,r},Le=e=>{const o=document.getElementById("popup-info-user-preview-template").content.querySelector(".popup__list-item").cloneNode(!0);return o.textContent=e.name,o},Q=e=>{W().then(t=>{const o=t.find(n=>n._id===e);if(!o){console.error("Карточка не найдена");return}f.innerHTML="",O.innerHTML="",f.append(h("Описание:",o.name)),f.append(h("Дата создания:",Ce(new Date(o.createdAt)))),o.owner&&f.append(h("Владелец:",o.owner.name));const r=o.likes?o.likes.length:0;f.append(h("Количество лайков:",r.toString())),o.likes&&o.likes.length>0?(N.textContent="Лайкнули:",o.likes.forEach(n=>{O.append(Le(n))})):N.textContent="Лайкнули:",m(y)}).catch(t=>{console.error("Ошибка загрузки данных карточки:",t)})},X=({name:e,link:t})=>{F.src=t,F.alt=e,Se.textContent=e,m(B)},qe=e=>{e.preventDefault();const t=d.querySelector(".popup__button"),o=t.textContent;t.textContent="Сохранение...",t.disabled=!0,te({name:z.value,about:K.value}).then(r=>{w.textContent=r.name,A.textContent=r.about,d.reset(),i(x)}).catch(r=>{console.error("Ошибка обновления профиля:",r)}).finally(()=>{t.textContent=o,t.disabled=!1})},ge=e=>{if(e.preventDefault(),!$.value){console.error("URL аватара пустой");return}const t=p.querySelector(".popup__button"),o=t.textContent;t.textContent="Сохранение...",t.disabled=!0,oe({avatar:$.value}).then(r=>{T.style.backgroundImage=`url(${r.avatar})`,p.reset(),i(M)}).catch(r=>{console.error("Ошибка обновления аватара:",r)}).finally(()=>{t.textContent=o,t.disabled=!1})},ke=e=>{if(e.preventDefault(),!b){console.error("ID пользователя еще не загружен");return}const t=a.querySelector(".popup__button"),o=t.textContent;t.textContent="Создание...",t.disabled=!0,re({name:ye.value,link:he.value}).then(r=>{V.prepend(j(r,b,{onPreviewPicture:X,onLikeIcon:H,onDeleteCard:Y,onInfoClick:Q})),a.reset(),i(I)}).catch(r=>{console.error("Ошибка добавления карточки:",r)}).finally(()=>{t.textContent=o,t.disabled=!1})},Y=(e,t)=>{S=e,v=t,m(P)},Ee=e=>{if(e.preventDefault(),!S||!v)return;const t=G.querySelector(".popup__button"),o=t.textContent;t.textContent="Удаление...",t.disabled=!0,ce(S,v).then(()=>{i(P),S=null,v=null}).catch(r=>{console.error("Ошибка удаления карточки:",r)}).finally(()=>{t.textContent=o,t.disabled=!1})};d.addEventListener("submit",qe);a.addEventListener("submit",ke);p.addEventListener("submit",ge);G.addEventListener("submit",Ee);ve.addEventListener("click",()=>{z.value=w.textContent,K.value=A.textContent,E(d,C),m(x)});T.addEventListener("click",()=>{p.reset(),E(p,C),m(M)});be.addEventListener("click",()=>{a.reset(),E(a,C),m(I)});const xe=document.querySelectorAll(".popup");xe.forEach(e=>{ie(e)});fe(C);let b="";Promise.all([W(),ee()]).then(([e,t])=>{b=t._id,w.textContent=t.name,A.textContent=t.about,T.style.backgroundImage=`url(${t.avatar})`,e.forEach(o=>{V.append(j(o,b,{onPreviewPicture:X,onLikeIcon:H,onDeleteCard:Y,onInfoClick:Q}))})}).catch(e=>{console.error("Ошибка загрузки данных:",e)});
